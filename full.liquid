<style>
.card { border-radius: 12px; padding: 10px; }
.time-display { line-height: 1.0; }
.divider-subtle { border-color: rgba(255,255,255,0.06); }
.divider-footer { border-color: rgba(255,255,255,0.09); }
.spacing-xs { margin-top: 4px; }
.badge-row { font-family: sans-serif; display: flex; gap: 5px; flex-wrap: nowrap; }
.badge-on { background: white; border-radius: 10px; padding: 10px 5px; color: #000; font-weight: bold; font-size: 10px; white-space: nowrap; }
</style>


{% assign station = root.station[0] %}
{% assign pst_offset = 3600 | times: -8 %}
{% assign now_utc = "now" | date: "%s" %}
{% assign now_pst = now_utc | plus: pst_offset %}

{% comment %} Convert badge_visibility array to string - using proper TRMNL path {% endcomment %}
{% assign badge_visibility_raw = trmnl.plugin_settings.custom_fields_values.badge_visibility %}
{% if badge_visibility_raw %}
  {% assign badge_visibility_str = badge_visibility_raw | join: "," %}
{% else %}
  {% assign badge_visibility_str = "platform,bike,delay,cancel" %}
{% endif %}

{% comment %} Convert bart_train_lines array to string for filtering {% endcomment %}
{% assign bart_train_lines_raw = trmnl.plugin_settings.custom_fields_values.bart_train_lines %}
{% if bart_train_lines_raw %}
  {% assign bart_train_lines_str = bart_train_lines_raw | join: "," %}
{% else %}
  {% assign bart_train_lines_str = "" %}
{% endif %}

{% comment %} Count total available unique train lines for smart filter display {% endcomment %}
{% assign total_available_lines = "" %}
{% if station.etd %}
  {% for etd in station.etd %}
    {% assign line_abbr = etd.abbreviation %}
    {% unless total_available_lines contains line_abbr %}
      {% assign total_available_lines = total_available_lines | append: line_abbr | append: "," %}
    {% endunless %}
  {% endfor %}
{% endif %}

<div class="title_bar">
  <img class="image" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgdmVyc2lvbj0iMS4xIgogICB4PSIwcHgiCiAgIHk9IjBweCIKICAgdmlld0JveD0iLTkuNjkzIDAuMDYzIDk2LjY1ODAwMSAxMDAiCiAgIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgLTkuNjkzIDAuMDYzIDk2LjY1OSAxMDAiCiAgIHhtbDpzcGFjZT0icHJlc2VydmUiCiAgIGlkPSJzdmc4IgogICBzb2RpcG9kaTpkb2NuYW1lPSJub3VuLXRyYWluLTE3MDcuc3ZnIgogICB3aWR0aD0iOTYuNjU3OTk3IgogICBoZWlnaHQ9IjEwMCIKICAgaW5rc2NhcGU6dmVyc2lvbj0iMS4yIChkYzJhZWRhZjAzLCAyMDIyLTA1LTE1KSIKICAgeG1sbnM6aW5rc2NhcGU9Imh0dHA6Ly93d3cuaW5rc2NhcGUub3JnL25hbWVzcGFjZXMvaW5rc2NhcGUiCiAgIHhtbG5zOnNvZGlwb2RpPSJodHRwOi8vc29kaXBvZGkuc291cmNlZm9yZ2UubmV0L0RURC9zb2RpcG9kaS0wLmR0ZCIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcwogICAgIGlkPSJkZWZzMTIiIC8+PHNvZGlwb2RpOm5hbWVkdmlldwogICAgIGlkPSJuYW1lZHZpZXcxMCIKICAgICBwYWdlY29sb3I9IiNmZmZmZmYiCiAgICAgYm9yZGVyY29sb3I9IiMwMDAwMDAiCiAgICAgYm9yZGVyb3BhY2l0eT0iMC4yNSIKICAgICBpbmtzY2FwZTpzaG93cGFnZXNoYWRvdz0iMiIKICAgICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMC4wIgogICAgIGlua3NjYXBlOnBhZ2VjaGVja2VyYm9hcmQ9IjAiCiAgICAgaW5rc2NhcGU6ZGVza2NvbG9yPSIjZDFkMWQxIgogICAgIHNob3dncmlkPSJmYWxzZSIKICAgICBpbmtzY2FwZTp6b29tPSIxLjg4OCIKICAgICBpbmtzY2FwZTpjeD0iNDguMTk5MTUzIgogICAgIGlua3NjYXBlOmN5PSI0Ny42Njk0OTIiCiAgICAgaW5rc2NhcGU6d2luZG93LXdpZHRoPSIxOTIwIgogICAgIGlua3NjYXBlOndpbmRvdy1oZWlnaHQ9IjExNzQiCiAgICAgaW5rc2NhcGU6d2luZG93LXg9Ii0xMSIKICAgICBpbmtzY2FwZTp3aW5kb3cteT0iLTExIgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjEiCiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0ic3ZnOCIgLz48cGF0aAogICAgIGQ9Ik0gODYuMDIyLDQ2Ljc5NiA4MS4yNDMsMTMuMzI3IEMgODAuNzI0LDkuNyA3Ny42MTYsNS4zODggNzQuMzM3LDMuNzQ4IGMgMCwwIC03LjM3MSwtMy42ODUgLTM0LjAyOSwtMy42ODUgLTI2LjY2NywwIC0zNy4zNzEsMy42ODUgLTM3LjM3MSwzLjY4NSAtMy4yOCwxLjY0IC02LjM4OSw1Ljk1MiAtNi45MDcsOS41NzkgbCAtNC43NzksMzMuNDY5IGMgLTAuNTE5LDMuNjI3IC0wLjk0NCw5LjYwMiAtMC45NDQsMTMuMjY4IDAsMy42NjYgMS4zNDYsOS4zNDMgMi45NzgsMTIuNjIyIGwgMC43MDQsMS40MDcgYyAxLjY0NywzLjI3OSA1Ljg5Myw2LjY5NyA5LjQ1MSw3LjU3OSBsIDMuNTM1LDAuODkgdiA3LjQ5NDAwMiBMIDMuNjQsMTAwLjA2MyBoIDYuNjY3IGwgMi4yMiwtNi42NjY5OTggaCA1Mi4yMTkgbCAyLjIyLDYuNjY2OTk4IGggNi42NjcgTCA3MC4zLDkwLjA1NjAwMiBWIDgyLjU2MiBsIDMuNTM0LC0wLjg5IGMgMy41NTgsLTAuODgyIDcuODEyLC00LjMgOS40NTEsLTcuNTc5IGwgMC42OTUsLTEuNDA3IGMgMS42NCwtMy4yNzkgMi45ODUsLTguOTU2IDIuOTg1LC0xMi42MjIgMCwtMy42NjYgLTAuNDI0LC05LjY0MSAtMC45NDMsLTEzLjI2OCB6IG0gLTgwLjcxOSwyNi42IGMgLTIuNzYxLDAgLTQuOTk2LC0yLjI0MiAtNC45OTYsLTUuMDA0IDAsLTIuNzYxIDIuMjM1LC01LjAwNCA0Ljk5NiwtNS4wMDQgMi43NjEsMCA1LjAwNCwyLjI0MyA1LjAwNCw1LjAwNCAwLDIuNzYyIC0yLjI0Myw1LjAwNCAtNS4wMDQsNS4wMDQgeiBNIDQyLjUyNyw1MC43MjkgYyAwLDEuNDY2IC0xLjE5OSwyLjY2NCAtMi42NjksMi42NjQgSCAyLjYwNCBjIC0xLjQ3LDAgLTIuNTIxLC0xLjE4NyAtMi4zNDQsLTIuNjQ1IEwgNC41NzUsMTYuMDQyIGMgMC4xODYsLTEuNDU0IDEuNTMyLC0yLjY0NSAyLjk5MywtMi42NDUgaCAzMi4yODkgYyAxLjQ2MiwwIDIuNjY5LDEuMTk5IDIuNjY5LDIuNjY0IHYgMzQuNjY4IHogbSAyOS40NDIsMjIuNjY3IGMgLTIuNzYxLDAgLTUuMDA0LC0yLjI0MiAtNS4wMDQsLTUuMDA0IDAsLTIuNzYxIDIuMjQzLC01LjAwNCA1LjAwNCwtNS4wMDQgMi43NjIsMCA0Ljk5NiwyLjI0MyA0Ljk5Niw1LjAwNCAxMGUtNCwyLjc2MiAtMi4yMzQsNS4wMDQgLTQuOTk2LDUuMDA0IHoiCiAgICAgaWQ9InBhdGgyIiAvPjwvc3ZnPgo=">
  <span class="title">{{ station.name }} BART</span>
  <span class="instance">
    {% assign direction = trmnl.plugin_settings.custom_fields_values.bart_direction %}
    {% assign total_lines_array = total_available_lines | split: ',' %}
    {% assign filter_lines_array = bart_train_lines_str | split: ',' %}
    {% assign has_line_filter = false %}
    {% if bart_train_lines_str and bart_train_lines_str != '' and filter_lines_array.size < total_lines_array.size %}
      {% assign has_line_filter = true %}
    {% endif %}

    {% if direction and direction != "" %}
      {% if direction == 'n' or direction == 'N' %}North{% elsif direction == 's' or direction == 'S' %}South{% else %}{{ direction | capitalize }}{% endif %}
    {% endif %}
    {% if has_line_filter %}
      {% if direction and direction != "" %} · {% endif %}{{ bart_train_lines_str }}
    {% endif %}
  </span>
</div> 
<div class="layout layout--col gap--small">
  <div class="header">

    <!-- DEBUG: badge_visibility = "{{ badge_visibility }}" -->
    {% if bart_direction and bart_direction != "" %}
      <div class="label label--small text--gray-60 spacing-xs">
        Direction: {{ bart_direction | capitalize }}
      </div>
    {% endif %}
  </div>

  <div class="grid grid--cols-4 gap--small">
    {% assign train_count = 0 %}

    {% if station.etd %}
      <!-- Display trains in chronological order by iterating through minute values -->
      {% for minute in (0..60) %}
        {% if train_count >= 12 %}
          {% break %}
        {% endif %}

        {% for etd in station.etd %}
          {% if train_count >= 12 %}
            {% break %}
          {% endif %}

          {% assign line_abbr = etd.abbreviation %}

          <!-- Skip if train line filter exists and this line is not in it -->
          {% if bart_train_lines_str and bart_train_lines_str != '' %}
            {% assign filter_string = ',' | append: bart_train_lines_str | append: ',' %}
            {% assign search_string = ',' | append: line_abbr | append: ',' %}
            {% unless filter_string contains search_string %}
              {% continue %}
            {% endunless %}
          {% endif %}

          {% if etd.estimate %}
            {% for est in etd.estimate %}
              {% if train_count >= 12 %}
                {% break %}
              {% endif %}

              {% assign est_minutes = est.minutes | plus: 0 %}
              {% if est.minutes == 'Leaving' %}
                {% assign est_minutes = 0 %}
              {% endif %}

              {% if est_minutes == minute %}
                <div class="item bg--black card">
                  <div class="content layout--col gap--small">
                    <div class="value value--small text--gray-60" style="letter-spacing: 0.3px; font-weight: bold;">
                      {{ etd.abbreviation }}
                    </div>

                    <div class="value value--small text--white time-display" style="font-size: 1.9em; font-weight: bold;">
                      {% if est.minutes == 'Leaving' or est.minutes == '0' %}
                        {% assign arrival_seconds = 0 %}
                      {% else %}
                        {% assign arrival_seconds = est.minutes | times: 60 %}
                      {% endif %}
                      {% assign arrival_timestamp = now_pst | plus: arrival_seconds %}
                      {% assign arrival_time_str = arrival_timestamp | date: "%-I:%M %p" %}
                      {{ arrival_time_str }}
                    </div>

                    <div class="divider divider-subtle"></div>

                    {% unless badge_visibility_str contains "no_badges" %}
                      <div class="badge-row">
                        {% if badge_visibility_str contains "platform" %}
                          <div class="badge-on">PLAT {{ est.platform }}</div>
                        {% endif %}

                        {% if badge_visibility_str contains "bike" %}
                          {% if est.bikeflag == "1" %}
                            <div class="badge-on">BIKE</div>
                          {% else %}
                            <span class="label label--small label--inverted text--gray-40">BIKE</span>
                          {% endif %}
                        {% endif %}

                        {% assign delay_num = est.delay | plus: 0 %}
                        {% if est.canceled == "1" %}
                          {% if badge_visibility_str contains "cancel" %}
                            <div class="badge-on">CANCEL</div>
                          {% endif %}
                        {% elsif badge_visibility_str contains "delay" %}
                          {% if delay_num > 0 %}
                            <div class="badge-on">DELAY</div>
                          {% else %}
                            <span class="label label--small label--inverted text--gray-40">DELAY</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    {% endunless %}
                  </div>
                </div>
                {% assign train_count = train_count | plus: 1 %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% endif %}

    {% if train_count == 0 %}
      <div class="item bg--black card" style="grid-column: 1 / -1;">
        <div class="content layout--col gap--small">
          <div class="value value--xlarge text--white">⚠️</div>
          <div class="label label--small text--gray-40">No trains available</div>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="footer">
    <div class="divider divider-footer"></div>
    {% if last_updated %}
      <div class="label label--small text--gray-60">Updated {{ last_updated }}</div>
    {% endif %}
  </div>

</div>
